---
- name: Deploy Nginx from GitHub
  hosts: all
  become: yes
  vars:
    repo_url: "https://github.com/Airn123/ansible.git"
    config_file: "nginx.conf.j2"  # Файл в корне репозитория

  tasks:
    # 1. Установка Nginx
    - name: Install Nginx
      apt:
        name: nginx
        state: latest
        update_cache: yes

    # 2. Скачивание конфига напрямую с GitHub (Raw)
    - name: Download nginx config
      ansible.builtin.get_url:
        url: "https://raw.githubusercontent.com/Airn123/ansible/main/{{ config_file }}"
        dest: "/tmp/{{ config_file }}"
        mode: '0644'

    # 3. Применение конфига
    - name: Apply nginx configuration
      ansible.builtin.copy:
        src: "/tmp/{{ config_file }}"
        dest: "/etc/nginx/nginx.conf"
        owner: root
        group: root
        mode: '0644'
      notify: restart nginx

    # 4. Проверка конфигурации
    - name: Validate nginx config
      command: nginx -t
      register: nginx_test
      changed_when: false
      notify: restart nginx

    # 5. Очистка временного файла
    - name: Cleanup temp file
      file:
        path: "/tmp/{{ config_file }}"
        state: absent

  handlers:
    - name: restart nginx
      ansible.builtin.service:
        name: nginx
        state: restarted
